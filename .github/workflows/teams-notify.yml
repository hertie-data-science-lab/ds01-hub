name: Teams notification

on:
  issues:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Teams notification
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          LABEL=$(echo "$ISSUE_LABELS" | jq -r '.[0].name // "Issue"')

          PAYLOAD=$(jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg url "$ISSUE_URL" \
            --arg label "$LABEL" \
            --arg author "$ISSUE_AUTHOR" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "0076D7",
              "summary": "New issue in ds01-hub",
              "sections": [{
                "activityTitle": "[\($title)](\($url))",
                "facts": [
                  {"name": "Type", "value": $label},
                  {"name": "Opened by", "value": $author}
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Issue",
                "targets": [{"os": "default", "uri": $url}]
              }]
            }')

          curl -sf -H "Content-Type: application/json" -d "$PAYLOAD" "$TEAMS_WEBHOOK_URL"

# ============================================================
# SETUP INSTRUCTIONS FOR TEAMS WEBHOOK
# ============================================================
# 1. In Microsoft Teams, go to the channel where you want notifications
# 2. Click the "..." menu > Connectors > Incoming Webhook
# 3. Name it "ds01-hub" and click Create
# 4. Copy the webhook URL
# 5. In GitHub repo: Settings > Secrets and variables > Actions
# 6. Click "New repository secret"
# 7. Name: TEAMS_WEBHOOK_URL
# 8. Value: paste the webhook URL
# 9. Click "Add secret"
# ============================================================
